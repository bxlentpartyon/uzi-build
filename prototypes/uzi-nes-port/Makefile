CA := ca65
CC := cc65
LD := ld65

CAFLAGS := --include-dir include/asm

PLATFORM := uzi

TARGET := uzi.nes
LINKER_SCRIPT := scripts/linker/uzi.cfg

KERNEL_OBJECTS := head.o kernel.o
KERNEL_OBJ_DIR := kernel
KERNEL_DEPS := $(patsubst %, $(KERNEL_OBJ_DIR)/%, $(KERNEL_OBJECTS))

.PRECIOUS: %.s %.o
.SUFFIXES:

all: $(TARGET)

%.s: %.c
	@echo "Building .c to .s $<"
	$(CC) --target $(PLATFORM) -I$(CC65_DIR)/include/ -I$(PWD)/include/ -O $<

%.o: %.S
	@echo "Building .S $<"
	$(CA) $(CAFLAGS) -o $@ $<

%.o: %.s
	# Note that we don't include CAFLAGS here, since .s files are generated by
	# the compiler.  We don't want to pollute the build with anything more than
	# necessary here.
	@echo "Building .s $<"
	$(CA) -o $@ $<

$(TARGET): $(KERNEL_DEPS) $(LINKER_SCRIPT)
	$(LD) -v -m link.map -C $(LINKER_SCRIPT) -o $@ $(KERNEL_DEPS) uzi.lib

clean:
	rm -f *.o *.nes *.s link.map

