CA := ca65
CC := cc65
LD := ld65

PLATFORM := uzi

TARGET := uzi.nes
LINKER_SCRIPT := scripts/linker/uzi.cfg

HEADER_DEPS := $(wildcard include/*.h)

KERNEL_ASM_OBJS := asm/head.o asm/interrupts.o asm/clock.o
KERNEL_OBJS := machdep.o process.o kdata.o scall1.o scall2.o
KERNEL_OBJ_DIR := kernel
KERNEL_DEPS := $(patsubst %, $(KERNEL_OBJ_DIR)/%, $(KERNEL_OBJS) $(KERNEL_ASM_OBJS))

PPU_ASM_OBJS := asm/ppu_asm.o asm/ppu_databuf_asm.o
PPU_OBJS := ppu.o ppu_databuf.o
PPU_OBJ_DIR := ppu
PPU_DEPS := $(patsubst %, $(PPU_OBJ_DIR)/%, $(PPU_OBJS) $(PPU_ASM_OBJS))

FS_OBJS := filesys.o
FS_OBJ_DIR := fs
FS_DEPS := $(patsubst %, $(FS_OBJ_DIR)/%, $(FS_OBJS))

DRIVER_OBJS := devio.o devtty.o devppuwd.o kb/kb_asm.o kb/kb.o
DRIVER_OBJ_DIR := drivers
DRIVER_DEPS := $(patsubst %, $(DRIVER_OBJ_DIR)/%, $(DRIVER_OBJS))

LIB_OBJS := string.o
LIB_OBJ_DIR := lib
LIB_DEPS := $(patsubst %, $(LIB_OBJ_DIR)/%, $(LIB_OBJS))

ALL_DEPS := $(KERNEL_DEPS) $(PPU_DEPS) $(FS_DEPS) $(DRIVER_DEPS) $(LIB_DEPS)
ALL_EXTRA := $(patsubst %.o, %.s, $(ALL_DEPS))

FONT :=	font/newfont.chr

.PRECIOUS: %.s %.o
.SUFFIXES:

all: $(TARGET)

# Note that this basically makes _every_ C file depend on _every_ header.  This
# isn't ideal, but it's better than missing rebuilds that should occur when
# headers are changed.
%.s: %.c $(HEADER_DEPS)
	@echo "Building .c to .s $<"
	$(CC) --target $(PLATFORM) -DUZI -I$(CC65_DIR)/include/ -I$(PWD)/include/ -O $<

%.o: %.S
	@echo "Building .S $<"
	$(CA) -I$(CC65_DIR)/asminc/ -I$(PWD)/include/asm -o $@ $<

%.o: %.s
        # Note that we don't include CAFLAGS here, since .s files are generated by
        # the compiler.  We don't want to pollute the build with anything more than
        # necessary here.
	@echo "Building .s $<"
	$(CA) -o $@ $<

$(TARGET): $(ALL_DEPS) $(LINKER_SCRIPT) $(FONT)
	$(LD) -v -m link.map -C $(LINKER_SCRIPT) -o $@ $(ALL_DEPS) uzi.lib

clean:
	rm -f $(ALL_DEPS) $(ALL_EXTRA) uzi.nes link.map

